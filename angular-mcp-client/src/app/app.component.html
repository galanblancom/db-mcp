<div class="container">
  <h1>Angular MCP Client</h1>
  
  <div class="connection-panel">
    <input [(ngModel)]="sseUrl" placeholder="SSE URL (e.g., http://localhost:8081/mcp/sse)" />
    <button (click)="connect()" [disabled]="isConnected">{{ isConnected ? 'Connected' : 'Connect' }}</button>
    <span class="status-indicator" [class.connected]="isConnected">{{ isConnected ? '‚óè Connected' : '‚óã Disconnected' }}</span>
  </div>

  <div class="main-content">
    <div class="chat-panel">
      <div class="chat-header">
        <h2>üí¨ Chat with AI Assistant</h2>
        @if (currentThreadId) {
          <div class="thread-info">
            <span class="thread-badge">Thread: {{ currentThreadId.substring(0, 8) }}...</span>
          </div>
        }
        @if (!currentThreadId) {
          <div class="thread-info">
            <span class="thread-badge new">New Conversation</span>
          </div>
        }
      </div>
      <div class="chat-messages" #chatMessages>
        @if (chatHistory.length === 0) {
          <div class="welcome-message">
            <p>üëã Hello! I'm your database assistant with conversation memory.</p>
            <p>I can help you query databases and remember our previous exchanges.</p>
            <p>Try asking me about tables, running queries, or anything database-related!</p>
          </div>
        }
        @for (msg of chatHistory; track $index) {
          <div [class]="'chat-message ' + msg.type">
            <div class="message-label">{{ msg.type === 'user' ? 'You' : 'AI Assistant' }}</div>
            <div class="message-content" [innerHTML]="msg.content"></div>
          </div>
        }
        @if (isSendingMessage) {
          <div class="loading-message">
            <div class="loading-spinner"></div>
            <span class="loading-text">Thinking...</span>
          </div>
        }
      </div>
      <div class="chat-controls">
        <button (click)="newConversation()" class="control-button" title="Start a new conversation">
          üîÑ New Thread
        </button>
        <button (click)="clearConversation()" class="control-button" title="Clear current conversation">
          üóëÔ∏è Clear
        </button>
        <button (click)="toggleThreadsPanel()" class="control-button" [class.active]="showThreadsPanel" title="View all active conversations">
          üìã Threads ({{ threadCount }})
        </button>
        <button (click)="toggleAdvancedOptions()" class="control-button" title="Advanced options">
          ‚öôÔ∏è {{ showAdvancedOptions ? 'Hide' : 'Options' }}
        </button>
      </div>
      
      <!-- Threads Panel -->
      @if (showThreadsPanel) {
        <div class="threads-panel">
          <div class="threads-header">
            <h3>Conversation Threads</h3>
            <button (click)="toggleThreadsPanel()" class="close-button">√ó</button>
          </div>
          
          @if (loadingThreads) {
            <div class="threads-loading">
              <div class="loading-spinner"></div>
              <span>Loading threads...</span>
            </div>
          }
          
          @if (!loadingThreads) {
            <div class="threads-list">
              @if (allThreads.length === 0) {
                <div class="no-threads">
                  <p>No active conversations</p>
                  <button (click)="newConversation(); toggleThreadsPanel();" class="primary-button">
                    Start New Thread
                  </button>
                </div>
              }
              
              @for (thread of allThreads; track thread.id) {
                <div 
                  class="thread-item"
                  [class.active]="thread.id === currentThreadId"
                  (click)="switchToThread(thread.id)">
                  <div class="thread-header">
                    <span class="thread-id">{{ thread.id.substring(0, 8) }}...</span>
                    <button 
                      (click)="deleteThread(thread.id, $event)" 
                      class="delete-thread-button"
                      title="Delete thread">
                      üóëÔ∏è
                    </button>
                  </div>
                  <div class="thread-preview">{{ thread.preview }}</div>
                  @if (thread.id === currentThreadId) {
                    <div class="thread-indicator">
                      ‚óè Current
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
      
      @if (showAdvancedOptions) {
        <div class="advanced-options">
          <div class="option-row">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="useChromaDB" />
              Use ChromaDB/Ollama Context
            </label>
            @if (useChromaDB) {
              <input 
                type="text" 
                [(ngModel)]="chromaDBCollection" 
                placeholder="Collection name (optional)"
                class="collection-input" />
            }
          </div>
          
          <div class="option-row">
            <label class="file-upload-label">
              üìé Attach Files (OpenAI Context)
              <input 
                type="file" 
                multiple 
                (change)="onFilesSelected($event)"
                style="display: none;" 
                #fileInput />
            </label>
            <button (click)="fileInput.click()" class="upload-button">Choose Files</button>
          </div>
          
          @if (selectedFiles.length > 0) {
            <div class="selected-files">
              @for (file of selectedFiles; track $index) {
                <div class="file-chip">
                  <span>{{ file.name }} ({{ (file.size / 1024).toFixed(1) }} KB)</span>
                  <button (click)="removeFile($index)" class="remove-file">√ó</button>
                </div>
              }
            </div>
          }
        </div>
      }
      
      <div class="chat-input-container">
        <input 
          [(ngModel)]="chatMessage" 
          (keyup.enter)="sendChatMessage()"
          [disabled]="isSendingMessage"
          [placeholder]="isSendingMessage ? 'Waiting for response...' : 'Ask me about your database...'"
          class="chat-input" />
        <button (click)="sendChatMessage()" [disabled]="isSendingMessage" class="send-button">
          {{ isSendingMessage ? 'Waiting...' : 'Send' }}
        </button>
      </div>
    </div>

    <div class="tools-panel">
      <h2>Available Tools</h2>
      <div class="tools-panel-content">
        @for (tool of (tools$ | async) ?? []; track tool.name) {
          <div class="tool-card">
            <h3>{{ tool.name }}</h3>
            <p>{{ tool.description }}</p>
            <button (click)="selectTool(tool)">Select</button>
          </div>
        }
      </div>
    </div>

    @if (selectedTool) {
      <div class="execution-panel">
        <h2>Execute: {{ selectedTool.name }}</h2>
        <textarea [(ngModel)]="toolArgs" rows="10" placeholder="JSON Arguments"></textarea>
        <button (click)="executeTool()">Execute</button>
        
        @if (executionResult) {
          <div class="result-box">
            <h3>Result:</h3>
            <pre>{{ executionResult | json }}</pre>
          </div>
        }
      </div>
    }
  </div>

  <div class="logs-panel">
    <h2>Logs</h2>
    <div class="logs-container">
      @for (log of (logs$ | async) ?? []; track $index) {
        <div>{{ log }}</div>
      }
    </div>
  </div>
</div>
